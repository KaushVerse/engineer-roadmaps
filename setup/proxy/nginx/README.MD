# â‡ï¸ NGINX â€“ Production Reverse Proxy & SSL Setup

This guide explains **productionâ€‘grade NGINX setup** for APIs, dashboards (Grafana, Jenkins), and RabbitMQ UI with **HTTP â†’ HTTPS**, **Certbot**, and **multiâ€‘domain routing**.

---

## ğŸ§± Architecture Overview

```
Internet ğŸŒ
   â”‚
   â–¼
NGINX (80 / 443)
   â”‚
   â”œâ”€â”€ api.twosouls.kaushverse.com   â†’ 127.0.0.1:5000
   â”œâ”€â”€ grafana.kaushverse.com        â†’ 127.0.0.1:3000
   â”œâ”€â”€ jenkins.kaushverse.com        â†’ 127.0.0.1:8080
   â””â”€â”€ rmq.kaushverse.com            â†’ 127.0.0.1:15672
```

NGINX acts as:

* ğŸ” Reverse Proxy
* ğŸ” SSL Termination
* ğŸŒ Single public entrypoint

---

## âœ… STEP 1: Install NGINX (Host Machine)

```bash
sudo apt update
sudo apt install nginx -y
```

Check status:

```bash
sudo systemctl status nginx
```

---

## âœ… STEP 2: Single Domain Reverse Proxy (API Example)

Create config file:

```bash
sudo nano /etc/nginx/sites-available/api.conf
```

Paste:

```nginx
server {
    listen 80;
    server_name api.twosouls.kaushverse.com;

    location / {
        proxy_pass http://127.0.0.1:5000;

        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_cache_bypass $http_upgrade;
    }
}
```

Save & exit: `CTRL + X â†’ Y â†’ Enter`

---

## âœ… STEP 3: Enable Site

```bash
sudo ln -s /etc/nginx/sites-available/api.conf /etc/nginx/sites-enabled/
```

(Optional but recommended)

```bash
sudo rm /etc/nginx/sites-enabled/default
```

Test & reload:

```bash
sudo nginx -t
sudo systemctl reload nginx
```

---

## âœ… STEP 4: DNS Verification

```bash
ping api.twosouls.kaushverse.com
```

Must resolve to your server IP.

---

## âœ… STEP 5: HTTP Test (MANDATORY)

Open in browser:

```
http://api.twosouls.kaushverse.com
```

âš ï¸ If HTTP does not work â†’ **Certbot will fail**.

---

## ğŸ” STEP 6: Enable HTTPS (Certbot)

Install certbot:

```bash
sudo apt install certbot python3-certbot-nginx -y
```

Issue certificate:

```bash
sudo certbot --nginx -d api.twosouls.kaushverse.com
```

Choose:

```
2 â†’ Redirect HTTP to HTTPS (recommended)
```

---

## ğŸ”„ STEP 7: Autoâ€‘Renewal Test

```bash
sudo certbot renew --dry-run
```

---

# ğŸŒ Multiple Domain Setup (PRODUCTION STYLE)

ğŸ‘‰ **Do NOT use `sites-available / sites-enabled`**
ğŸ‘‰ Use `conf.d/*.conf` (clean & scalable)

Directory:

```
/etc/nginx/
â”œâ”€â”€ nginx.conf
â””â”€â”€ conf.d/
    â”œâ”€â”€ grafana.conf
    â”œâ”€â”€ jenkins.conf
    â””â”€â”€ rmq.conf
```

---

## ğŸ§© STEP 1: Ensure conf.d is Included

```bash
sudo nano /etc/nginx/nginx.conf
```

Inside `http {}` block:

```nginx
include /etc/nginx/conf.d/*.conf;
```

---

## ğŸ§© STEP 2: Grafana Config Example

```bash
sudo nano /etc/nginx/conf.d/grafana.conf
```

```nginx
server {
    listen 80;
    server_name grafana.kaushverse.com;

    location / {
        proxy_pass http://127.0.0.1:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

---

## ğŸ§© STEP 3: Jenkins & RabbitMQ (Same Pattern)

### Jenkins

```nginx
server {
    listen 80;
    server_name jenkins.kaushverse.com;

    location / {
        proxy_pass http://127.0.0.1:8080;
    }
}
```

### RabbitMQ Management UI

```nginx
server {
    listen 80;
    server_name rmq.kaushverse.com;

    location / {
        proxy_pass http://127.0.0.1:15672;
    }
}
```

---

## ğŸ”„ STEP 4: Reload NGINX

```bash
sudo nginx -t
sudo systemctl reload nginx
```

---

## ğŸŒ STEP 5: HTTP TEST (VERY IMPORTANT)

All must open on HTTP **before SSL**:

```
http://grafana.kaushverse.com
http://jenkins.kaushverse.com
http://rmq.kaushverse.com
```

---

## ğŸ” STEP 6: SSL for Each Domain

```bash
sudo certbot --nginx -d grafana.kaushverse.com
sudo certbot --nginx -d jenkins.kaushverse.com
sudo certbot --nginx -d rmq.kaushverse.com
```

---

## ğŸ›¡ï¸ Production Best Practices

* âœ… Always test **HTTP first**, then SSL
* âŒ Never expose backend ports publicly
* ğŸ” Use HTTPS only for users
* ğŸ” Monitor cert expiry
* ğŸ“¦ One service = one `.conf`

---

## ğŸ§  Common Failures

| Issue            | Reason               |
| ---------------- | -------------------- |
| Certbot fails    | HTTP not reachable   |
| 502 Bad Gateway  | Backend service down |
| Wrong site opens | server_name mismatch |

---

## âœ… Final Checklist

* [ ] DNS points to server
* [ ] HTTP works
* [ ] SSL issued
* [ ] Autoâ€‘renew OK
* [ ] Backends private

---

ğŸ”¥ **This setup is productionâ€‘ready, scalable, and DevOpsâ€‘approved.**
